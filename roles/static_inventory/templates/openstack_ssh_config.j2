Host *
    IdentitiesOnly yes

Host {{ groups.bastions[0] }}
    Hostname {{ hostvars[groups.bastions[0]].public_v4 }}
    IdentityFile {{ hostvars[groups.bastions[0]].ansible_private_key_file }}
    User {{ ssh_user }}
    StrictHostKeyChecking no
    UserKnownHostsFile=/dev/null

{% for host in groups['all'] | difference(groups['bastions'][0]) %}

Host {{ host }}
    Hostname {{ hostvars[host].ansible_host }}
    ProxyCommand {{ ssh_proxy_command  }} -W {{ hostvars[host].private_v4 }}:22
    IdentityFile {{ hostvars[host].ansible_private_key_file }}
    User {{ ssh_user }}
    StrictHostKeyChecking no
    UserKnownHostsFile=/dev/null

{% endfor %}
